#!/bin/bash

set -e

export DIRTY="true"
if [ -z "${CODEBUILD_START_TIME}" ]; then export CODEBUILD_START_TIME=$(date '+%d/%m/%Y %H:%M:%S'); fi
if [ -z "${CODEBUILD_RESOLVED_SOURCE_VERSION}" ]; then export CODEBUILD_RESOLVED_SOURCE_VERSION=$(git rev-parse HEAD); fi

if [ -z "${CODEBUILD_START_TIME}" ]; then
    export CODEBUILD_START_TIME=$(date '+%d/%m/%Y %H:%M:%S')
    if [ $(git status --porcelain) == "" ]; then export DIRTY="false"; fi
else 
    export CODEBUILD_WEBHOOK_TRIGGER="manual"
    export CODEBUILD_BUILD_ID="n/a"
    export CODEBUILD_BUILD_IMAGE="n/a"
    export CODEBUILD_BUILD_NUMBER="n/a"
    export CODEBUILD_INITIATOR="n/a"
    export CODEBUILD_LOG_PATH="n/a"
    export CODEBUILD_SOURCE_REPO_URL="n/a"
    export CODEBUILD_SOURCE_VERSION=$(git branch --show-current)
fi

envsubst < src/main/web/build.template > src/main/web/build.js