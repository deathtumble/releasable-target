version: 0.2
phases:
  pre_build:
    commands:
     - BUILD_VERSION="${CODEBUILD_RESOLVED_SOURCE_VERSION:="XXXXXX"}"
     - export SHA1_START=`echo ${BUILD_VERSION} | cut -c -2`
     - export SHA1_END=`echo ${BUILD_VERSION} | cut -c 3-`
     - REPO=$(pwd)
  build:
    commands:
      - # clean 
      - rm -rf ${REPO}/target
      - mkdir ${REPO}/target
      - # build lambda artifact
      - mkdir ${REPO}/target/lambda 
      - cp ${REPO}/src/main/bash/* ${REPO}/target/lambda
      - pushd ${REPO}/target/lambda && zip -ur ../dist.zip * && popd
      - # build web artifact
      - mkdir ${REPO}/target/web 
      - src/main/bin/create_build_file
      - rsync -a --exclude='config.js' ${REPO}/src/main/web/* ${REPO}/target/web
      - pushd ${REPO}/target/web && zip -ur ../cloudfront.zip * && popd
      - # build terraform artifact
      - mkdir ${REPO}/target/terraform
      - rsync -a --exclude='.*' --exclude='.*' --exclude='graph.*' ${REPO}/src/main/terraform/* ${REPO}/target/terraform
      - pushd ${REPO}/target/terraform && zip -ur ../terraform.zip * && popd
      - # install artifacts
      - aws s3 cp --no-progress target/dist.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/objects/${SHA1_START}/${SHA1_END}/dist.zip
      - aws s3 cp --no-progress target/cloudfront.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/objects/${SHA1_START}/${SHA1_END}/cloudfront.zip
      - aws s3 cp --no-progress target/terraform.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/objects/${SHA1_START}/${SHA1_END}/terraform.zip
      - aws s3 cp --no-progress target/dist.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/refs/${CODEBUILD_WEBHOOK_TRIGGER}/dist.zip
      - aws s3 cp --no-progress target/cloudfront.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/refs/${CODEBUILD_WEBHOOK_TRIGGER}/cloudfront.zip
      - aws s3 cp --no-progress target/terraform.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/refs/${CODEBUILD_WEBHOOK_TRIGGER}/terraform.zip

