version: 0.2
phases:
  pre_build:
    commands:
     - BUILD_VERSION="${CODEBUILD_RESOLVED_SOURCE_VERSION:="XXXXXX"}"
     - export SHA1_START=`echo ${BUILD_VERSION} | cut -c -2`
     - export SHA1_END=`echo ${BUILD_VERSION} | cut -c 3-`

  build:
    commands:
      - src/main/bin/create_build_file
      - rm -rf target
      - mkdir target
      - # build lambda component
      - mkdir target/lambda
      - pushd target/lambda
      -     cp src/main/bash/* target/lambda
      -     zip -ur ../dist.zip *
      - popd
      - # build web component
      - mkdir target/web
      - pushd target/web
      -     rsync -a --exclude='config.js' src/main/web/* target/web
      -     zip -ur ../cloudfront.zip *
      - pushd
      - # build terraform component
      - mkdir target/terraform
      - pushd target/terraform
      -     rsync -a --exclude='.*' --exclude='.*' --exclude='graph.*' src/main/terraform/* target/terraform
      -     zip -ur ../terraform.zip *
      - popd
      - # install 
      - aws s3 cp --no-progress target/dist.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/objects/${SHA1_START}/${SHA1_END}/dist.zip
      - aws s3 cp --no-progress target/cloudfront.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/objects/${SHA1_START}/${SHA1_END}/cloudfront.zip
      - aws s3 cp --no-progress target/terraform.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/objects/${SHA1_START}/${SHA1_END}/terraform.zip
      - aws s3 cp --no-progress target/dist.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/refs/${CODEBUILD_WEBHOOK_TRIGGER}/dist.zip
      - aws s3 cp --no-progress target/cloudfront.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/refs/${CODEBUILD_WEBHOOK_TRIGGER}/cloudfront.zip
      - aws s3 cp --no-progress target/terraform.zip s3://${S3_BUILD_BUCKET}/builds/releasable-target/refs/${CODEBUILD_WEBHOOK_TRIGGER}/terraform.zip

